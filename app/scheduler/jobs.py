# app/scheduler/jobs.py
from datetime import date, datetime, timedelta
from typing import List, Tuple, Optional

from aiogram import Bot
from aiogram.exceptions import TelegramBadRequest, TelegramForbiddenError  # –î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏

from app.database import requests as db_requests # –ù–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞–ø—Ä—è–º—É—é, –∞ –ø–æ–ª—É—á–∞–µ–º —á–µ—Ä–µ–∑ initialize_scheduler_dependencies

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ run.py
_bot: Optional[Bot] = None
_db_requests = None  # –¢–∏–ø–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç —Å–ª–æ–∂–Ω–æ–π, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –º–æ–¥—É–ª—å, –æ—Å—Ç–∞–≤–∏–º None


# _admin_chat_id: Optional[str] = None # –ë–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω

def initialize_scheduler_dependencies(bot_instance: Bot, db_requests_module, admin_chat_id: Optional[str] = None):
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–æ–±—ä–µ–∫—Ç –±–æ—Ç–∞, –º–æ–¥—É–ª—å –ë–î).
    admin_chat_id –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á,
    –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ sendDailyReminders.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    """
    global _bot, _db_requests  # _admin_chat_id –Ω–µ –¥–µ–ª–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–º –∑–¥–µ—Å—å
    _bot = bot_instance
    _db_requests = db_requests_module
    # –ï—Å–ª–∏ admin_chat_id –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –∞–¥–º–∏–Ω—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ —ç—Ç–æ–º –º–æ–¥—É–ª–µ,
    # –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å: global _admin_chat_id; _admin_chat_id = admin_chat_id


async def sendDailyReminders():
    """
    –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ –∏—Ö –∑–∞–ø–∏—Å—è—Ö –Ω–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å.
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ª–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    if _bot is None or _db_requests is None:
        print("–û—à–∏–±–∫–∞: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã. –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
        return

    today = date.today()

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
    # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã User, Service –∏ Barber
    bookings_for_day = await db_requests.getBookingsForDate(today)

    if not bookings_for_day:
        print(f"–ù–∞ {today.strftime('%d.%m.%Y')} –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.")
        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É, —á—Ç–æ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç.
        # if _admin_chat_id: # –ï—Å–ª–∏ _admin_chat_id –±—ã–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ
        #     try:
        #         await _bot.send_message(chat_id=_admin_chat_id, text=f"–ù–∞ {today.strftime('%d.%m.%Y')} –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.")
        #     except Exception as e:
        #         print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∑–∞–ø–∏—Å–µ–π: {e}")
        return

    print(
        f"–ù–∞–π–¥–µ–Ω–æ {len(bookings_for_day)} –∑–∞–ø–∏—Å–µ–π –Ω–∞ {today.strftime('%d.%m.%Y')}. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è...")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    for booking in bookings_for_day:
        # –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –∑–∞–ø–∏—Å–∏
        # –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ booking.user - —ç—Ç–æ –æ–±—ä–µ–∫—Ç User, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –¥–∞–Ω–Ω–æ–π –∑–∞–ø–∏—Å—å—é
        user_id = booking.user.user_id
        service_name = booking.service.name if booking.service else "–£—Å–ª—É–≥–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"
        barber_name = booking.barber.name if booking.barber else "–õ—é–±–æ–π –º–∞—Å—Ç–µ—Ä"
        booking_time = booking.booking_date.strftime('%H:%M')
        booking_date_str = booking.booking_date.strftime('%d.%m.%Y')

        reminder_text = f"""<b>üóìÔ∏è –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–ø–∏—Å–∏!</b>

–í–∞—à–∞ –∑–∞–ø–∏—Å—å –Ω–∞ <b>{service_name}</b>
–ö –º–∞—Å—Ç–µ—Ä—É: <b>{barber_name}</b>
–ù–∞ –¥–∞—Ç—É: <b>{booking_date_str}</b>
–ù–∞ –≤—Ä–µ–º—è: <b>{booking_time}</b>

–ú—ã –∂–¥–µ–º –≤–∞—Å!"""

        try:
            await _bot.send_message(chat_id=user_id, text=reminder_text, parse_mode='HTML')
            print(f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} –æ –∑–∞–ø–∏—Å–∏ –Ω–∞ {booking_date_str} {booking_time}")
        except TelegramForbiddenError:
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: –±–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
            # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –ø–æ–º–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ
            # –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è –µ–≥–æ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ—à–∏–±–æ–∫.
        except TelegramBadRequest as e:
            # –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ Telegram API, –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–≤–µ—Ä–Ω—ã–π chat_id (–æ—á–µ–Ω—å —Ä–µ–¥–∫–æ –¥–ª—è user_id –∏–∑ –ë–î)
            print(f"–û—à–∏–±–∫–∞ Telegram API –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
        except Exception as e:
            # –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
            print(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

